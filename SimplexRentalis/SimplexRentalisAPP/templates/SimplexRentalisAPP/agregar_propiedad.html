{% extends 'base.html' %}
{% load static %}

{% block title %}
    Agregar Propiedad
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Agregar Nueva Propiedad</h2>

    <div class="row justify-content-center">
        <div class="col-12 col-md-8">
            <form method="POST" enctype="multipart/form-data" id="agregar-propiedad-form">
                {% csrf_token %}

                <!-- Nombre de la propiedad -->
                <div class="form-group">
                    <label for="id_nombre">Nombre de la propiedad</label>
                    <input type="text" name="nombre" class="form-control form-control-lg" required>
                </div>

                <!-- Descripción -->
                <div class="form-group">
                    <label for="id_descripcion">Descripción</label>
                    <textarea name="descripcion" class="form-control form-control-lg" rows="4" required></textarea>
                </div>

                <!-- Dirección -->
                <div class="form-group">
                    <label for="id_direccion">Dirección</label>
                    <input type="text" name="direccion" class="form-control form-control-lg" required>
                </div>

                <!-- Precio por noche -->
                <div class="form-group">
                    <label for="id_precio_noche">Precio por noche</label>
                    <input type="number" name="precio_noche" class="form-control form-control-lg" required>
                </div>

                <!-- Imágenes -->
                <div class="form-group">
                    <label for="id_imagenes">Imágenes</label>
                    <input type="file" name="imagenes" multiple class="form-control-file" id="imagenes" required onchange="previewImages(event)">
                    <div id="image-preview-container" class="mt-3">
                        <!-- Las miniaturas de las imágenes seleccionadas aparecerán aquí -->
                    </div>
                    <!-- Mostrar la cantidad de archivos seleccionados debajo del campo de imágenes -->
                    <p id="selected-count" class="mt-2 text-muted" style="font-size: 0.9em;">
                        <strong>Cantidad de archivos seleccionados: </strong> 0
                    </p>
                    <!-- Mensaje indicando que la primera imagen será portada si no se hace clic -->
                    <p class="mt-2 text-muted" style="font-size: 0.9em;">
                        <strong>Instrucciones:</strong> Puedes hacer clic sobre cualquier imagen para seleccionarla como portada. Si no haces clic en ninguna, la primera imagen subida será la portada por defecto. <br>
                        <strong>Recuerda:</strong> Debes subir al menos 5 imágenes y como máximo 15.
                    </p>
                </div>

                <!-- Permite mascotas -->
                <div class="form-group">
                    <label for="id_permite_mascotas">¿Permite mascotas?</label>
                    <input type="checkbox" name="permite_mascotas" id="permite_mascotas">
                </div>

                <!-- En mantenimiento -->
                <div class="form-group">
                    <label for="id_en_mantenimiento">¿En mantenimiento?</label>
                    <input type="checkbox" name="en_mantenimiento" id="en_mantenimiento">
                </div>

                <!-- Capacidad máxima -->
                <div class="form-group">
                    <label for="id_capacidad_maxima">Capacidad máxima</label>
                    <input type="number" name="capacidad_maxima" class="form-control form-control-lg" required>
                </div>

                <!-- Campo oculto para la portada -->
                <input type="hidden" name="portada" id="portada-id">

                <!-- Botón de enviar -->
                <div class="form-group text-center">
                    <button type="submit" class="btn btn-primary btn-lg w-100">Guardar Propiedad</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let selectedImages = [];  // Para almacenar todas las imágenes seleccionadas

    // Función para previsualizar imágenes seleccionadas
    function previewImages(event) {
        const files = event.target.files;
        const previewContainer = document.getElementById('image-preview-container');
        const selectedCount = document.getElementById('selected-count');

        // Mostrar cada archivo seleccionado como miniatura
        Array.from(files).forEach((file) => {
            if (selectedImages.length >= 15) {
                alert('Ya has seleccionado el máximo de 15 imágenes.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.classList.add('mr-2', 'image-thumbnail');  // Añadir clase para identificación
                img.onclick = function() {
                    setAsPortada(img); // Marcar esta imagen como portada al hacer clic
                };
                previewContainer.appendChild(img);

                // Agregar la imagen a la lista seleccionada
                selectedImages.push(img);

                // Verificar si ya se alcanzó el límite de imágenes
                if (selectedImages.length > 15) {
                    alert('No puedes seleccionar más de 15 imágenes.');
                }

                // Si es la primera imagen seleccionada, marcarla como portada
                if (selectedImages.length === 1) {
                    setAsPortada(img);
                }

                // Actualizar la cantidad de imágenes seleccionadas
                selectedCount.innerHTML = `<strong>Cantidad de archivos seleccionados: </strong> ${selectedImages.length}`;
            };
            reader.readAsDataURL(file);  // Leer el archivo seleccionado
        });

        // Verificar que se han seleccionado al menos 5 imágenes
        if (selectedImages.length < 5) {
            alert('Por favor, selecciona al menos 5 imágenes.');
        }
    }

    // Función para marcar una imagen como portada
    function setAsPortada(selectedImg) {
        // Eliminar la clase 'selected' de todas las miniaturas
        const allImages = document.querySelectorAll('.image-thumbnail');
        allImages.forEach(img => img.classList.remove('selected'));

        // Añadir la clase 'selected' a la imagen seleccionada
        selectedImg.classList.add('selected');

        // Guardar la URL de la imagen seleccionada en el campo oculto
        document.getElementById('portada-id').value = selectedImg.src;
    }

    // Validar el formulario antes de enviarlo
    document.getElementById('agregar-propiedad-form').onsubmit = function(event) {
        // Verificar que haya al menos 5 imágenes seleccionadas
        if (selectedImages.length < 5) {
            event.preventDefault();  // Evitar el envío si no se suben suficientes imágenes
            alert('Debes subir al menos 5 imágenes.');
        }
    };
</script>
{% endblock %}
