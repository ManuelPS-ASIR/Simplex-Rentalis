{% extends 'base.html' %}
{% load static %}
{% block title %}
Alquilar Propiedad
{% endblock %}

{% block content %}
<div id="main-content" style="max-width: 800px; margin: auto; font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; background-color: #f9f9f9; box-shadow: 0px 4px 12px rgba(0,0,0,0.15); border-radius: 10px;">

    <!-- Cuadro informativo con imagen y mensaje -->
    <div style="text-align: center; margin-bottom: 30px; padding: 20px; background-color: #ffffff; border-radius: 10px; box-shadow: 0px 8px 16px rgba(0,0,0,0.1);">
        {% if propiedad.galeria %}
        <img src="{{ propiedad.galeria.imagen.url }}" alt="Imagen de portada de {{ propiedad.nombre }}" style="width: 100%; height: auto; object-fit: cover; border-radius: 10px;">
        {% endif %}
        <h2 style="margin-top: 15px; font-size: 2em; color: #333; font-weight: bold; text-transform: uppercase;">Reserva en: <strong>{{ propiedad.nombre }}</strong></h2>
        <p style="font-size: 1.2em; color: #555; margin-top: 10px;">Haz tu reserva para disfrutar de una experiencia única.</p>
    </div>

    <!-- Formulario de reserva -->
    <form method="post" style="padding: 30px; background-color: #ffffff; border-radius: 10px; box-shadow: 0px 8px 16px rgba(0,0,0,0.1);">
        {% csrf_token %}
        
        <h2 style="margin-bottom: 20px; font-size: 1.8em; color: #333;">Detalles de la Reserva</h2>
        
        <!-- Sección de fechas -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div style="flex: 1; margin-right: 10px;">
                <label for="fecha_inicio" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">Fecha de Inicio</label>
                <input type="date" name="fecha_inicio" id="fecha_inicio" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; transition: all 0.3s ease;">
                <div id="fecha_inicio_error" style="color: red; font-size: 0.9em; display: none;">La fecha de inicio debe ser posterior a la fecha actual.</div>
            </div>
            <div style="flex: 1; margin-left: 10px;">
                <label for="fecha_fin" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">Fecha de Fin</label>
                <input type="date" name="fecha_fin" id="fecha_fin" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; transition: all 0.3s ease;">
                <div id="fecha_fin_error" style="color: red; font-size: 0.9em; display: none;">La fecha de fin debe ser posterior a la fecha de inicio y a la fecha actual.</div>
            </div>
        </div>

        <!-- Sección de personas -->
        <div style="margin-bottom: 20px;">
            <label for="personas" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">Número de Personas</label>
            <input type="number" name="personas" id="personas" min="1" max="{{ propiedad.capacidad_maxima }}" value="1" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; transition: all 0.3s ease;">
            <small style="color: #777;">Capacidad máxima: {{ propiedad.capacidad_maxima }} personas</small>
        </div>

        <!-- Sección de mascotas -->
        <div style="margin-bottom: 20px; display: flex; align-items: center;">
            <input type="checkbox" name="mascotas" id="mascotas" style="margin-right: 10px; transform: scale(1.3);">
            <label for="mascotas" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">¿Traerás mascotas?</label>
        </div>

        <!-- Botón de reserva -->
        <div style="text-align: center;">
            <button type="submit" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.5em; background-color: #007bff; border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.3s ease;">
                Confirmar Reserva
            </button>
        </div>
    </form>

</div>

<script>
    // Obtener la fecha actual
    const today = new Date().toISOString().split('T')[0];
    const fechaInicioInput = document.getElementById('fecha_inicio');
    const fechaFinInput = document.getElementById('fecha_fin');

    // Establecer la fecha mínima para que no se pueda seleccionar una fecha anterior a la actual
    fechaInicioInput.setAttribute('min', today);
    fechaFinInput.setAttribute('min', today);

    // Función para verificar si la fecha es válida y mostrar el mensaje de error
    function verificarFechaValida(fechaInput, errorMessageId) {
        const fechaSeleccionada = new Date(fechaInput.value);
        const errorMessageElement = document.getElementById(errorMessageId);

        // Si la fecha seleccionada es anterior a la fecha actual, se muestra el error
        if (fechaSeleccionada < new Date()) {
            fechaInput.style.borderColor = 'red'; // Cambia el borde a rojo
            errorMessageElement.style.display = 'block'; // Muestra el mensaje de error
        } else {
            fechaInput.style.borderColor = ''; // Resetea el borde
            errorMessageElement.style.display = 'none'; // Oculta el mensaje de error
        }
    }

    // Verificar fechas al escribir
    fechaInicioInput.addEventListener('input', function () {
        verificarFechaValida(fechaInicioInput, 'fecha_inicio_error');
        const fechaFin = fechaFinInput;
        fechaFin.setAttribute('min', this.value);
        verificarFechas(this, fechaFin);
    });

    fechaFinInput.addEventListener('input', function () {
        verificarFechaValida(fechaFinInput, 'fecha_fin_error');
        verificarFechas(fechaInicioInput, this);
    });

    // Verificar si las fechas son válidas en cuanto a disponibilidad
    const fechasNoDisponibles = JSON.parse('{{ fechas_no_disponibles_json|escapejs }}');

    function verificarFechas(fechaInicio, fechaFin) {
        const fechaSeleccionadaInicio = new Date(fechaInicio.value);
        const fechaSeleccionadaFin = new Date(fechaFin.value);

        fechasNoDisponibles.forEach(fecha => {
            const fechaNoDisponible = new Date(fecha);
            if (
                (fechaNoDisponible >= fechaSeleccionadaInicio && fechaNoDisponible <= fechaSeleccionadaFin)
            ) {
                alert(`La fecha ${fecha} no está disponible.`);
                fechaFin.value = ''; // Borra la fecha de fin si es no disponible
                fechaFin.style.borderColor = ''; // Resetea el borde del campo de fecha de fin
            }
        });
    }
</script>

{% endblock %}
