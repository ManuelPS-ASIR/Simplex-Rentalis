{% extends 'base.html' %}
{% load static %}
{% block title %}
Alquilar Propiedad
{% endblock %}
{% block content %}
<div id="main-content" style="max-width: 800px; margin: auto; font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; background-color: #f9f9f9; box-shadow: 0px 4px 12px rgba(0,0,0,0.15); border-radius: 10px;">

    <!-- Cuadro informativo con imagen y mensaje -->
    <div style="text-align: center; margin-bottom: 30px; padding: 20px; background-color: #ffffff; border-radius: 10px; box-shadow: 0px 8px 16px rgba(0,0,0,0.1);">
        {% if propiedad.galeria %}
        <img src="{{ propiedad.galeria.imagen.url }}" alt="Imagen de portada de {{ propiedad.nombre }}" style="width: 100%; height: auto; object-fit: cover; border-radius: 10px;">
        {% endif %}
        <h2 style="margin-top: 15px; font-size: 2em; color: #333; font-weight: bold; text-transform: uppercase;">Reserva en: <strong>{{ propiedad.nombre }}</strong></h2>
        <p style="font-size: 1.2em; color: #555; margin-top: 10px;">Haz tu reserva para disfrutar de una experiencia única.</p>
    </div>
    
    <!-- Formulario de reserva -->
    <form id="reserva-form" method="post" style="padding: 30px; background-color: #ffffff; border-radius: 10px; box-shadow: 0px 8px 16px rgba(0,0,0,0.1);">
        {% csrf_token %}
        
        <div id="step1">
            <h2 style="margin-bottom: 20px; font-size: 1.8em; color: #333;">Detalles de la Reserva</h2>
            
            <!-- Calendario de fechas -->
            <div style="margin-bottom: 20px;">
                <label for="fecha_reserva" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">Selecciona el rango de fechas</label>
                <input type="text" id="fecha_reserva" name="fecha_reserva" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; transition: all 0.3s ease;" placeholder="Selecciona fechas">
            </div>

            <!-- Mostrar el costo total -->
            <div id="costo_total" style="margin-bottom: 20px; font-size: 1.5em; color: #007bff; text-align: center; font-weight: bold;">
                Total: €0.00
            </div>

            <!-- Sección de personas -->
            <div style="margin-bottom: 20px;">
                <label for="personas" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">Número de Personas</label>
                <input type="number" name="personas" id="personas" min="1" max="{{ propiedad.capacidad_maxima }}" value="1" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; transition: all 0.3s ease;">
                <small style="color: #777;">Capacidad máxima: {{ propiedad.capacidad_maxima }} personas</small>
            </div>

            <!-- Sección de mascotas -->
            <div style="margin-bottom: 20px; display: flex; align-items: center;">
                <input type="checkbox" name="mascotas" id="mascotas" style="margin-right: 10px; transform: scale(1.3);">
                <label for="mascotas" style="font-size: 1.2em; color: #333; margin-bottom: 5px; display: block;">¿Traerás mascotas?</label>
            </div>

            <!-- Botón de siguiente -->
            <div style="text-align: center;">
                <button type="button" id="next-button" class="btn btn-primary" disabled style="padding: 15px 30px; font-size: 1.5em; background-color: #007bff; border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.3s ease;">
                    Siguiente
                </button>
            </div>
        </div>

        <div id="step2" style="display: none;">
            <h2 style="margin-bottom: 20px; font-size: 1.8em; color: #333;">Datos de las Personas</h2>

            {% for form in identidad_forms %}
                <fieldset style="margin-bottom: 20px;">
                    <legend>Persona {{ forloop.counter }}</legend>
                    {{ form.as_p }}
                </fieldset>
            {% empty %}
                <p>No hay formularios de identidad disponibles.</p>
            {% endfor %}

            <!-- Botón de confirmar -->
            <div style="text-align: center;">
                <button type="submit" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.5em; background-color: #007bff; border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.3s ease;">
                    Confirmar Reserva
                </button>
            </div>
        </div>
    </form>

</div>

<!-- Incluir Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> <!-- Cargar localización en español -->
<!-- Manejar el botón "Siguiente" -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fechas no disponibles en formato JSON
        const fechasNoDisponibles = JSON.parse('{{ fechas_no_disponibles_json|escapejs }}');
        console.log('Fechas no disponibles:', fechasNoDisponibles);

        const precioPorNoche = parseFloat('{{ propiedad.precio_por_noche|default:"100" }}'); // Precio por noche con valor predeterminado
        console.log('Precio por noche:', precioPorNoche);

        // Configurar Flatpickr
        const flatpickrInstance = flatpickr("#fecha_reserva", {
            mode: "range",
            minDate: "today",
            disable: fechasNoDisponibles.map(fecha => new Date(fecha)), // Convertir fechas a objetos Date
            dateFormat: "Y-m-d",
            locale: "es", // Configurar idioma español
            onChange: function(selectedDates) {
                const nextButton = document.getElementById('next-button');

                if (selectedDates.length > 1) {
                    const start = selectedDates[0]; // Fecha de inicio
                    const end = selectedDates[1];   // Fecha de fin
                    
                    // Calcular diferencia en días (no incluye el día de salida)
                    const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)); 
                    
                    // Calcular el total
                    const total = diffDays * precioPorNoche;

                    // Depuración
                    console.log('Inicio:', start);
                    console.log('Fin:', end);
                    console.log('Días de diferencia:', diffDays);
                    console.log('Total calculado:', total);

                    // Actualizar el costo total en el DOM
                    document.getElementById('costo_total').innerText = `Total: €${total.toFixed(2)}`;

                    // Habilitar el botón de siguiente si el rango es válido
                    nextButton.disabled = (diffDays <= 0); // Asegurarse de que el rango sea válido
                    console.log('Botón siguiente habilitado:', !nextButton.disabled);
                } else {
                    // Si no hay rango válido, mostrar €0.00
                    document.getElementById('costo_total').innerText = "Total: €0.00";

                    // Deshabilitar el botón de siguiente
                    nextButton.disabled = true;
                    console.log('Botón siguiente deshabilitado');
                }
            }
        });

        // Manejar el botón "Siguiente"
        document.getElementById('next-button').addEventListener('click', function () {
            const numPersonas = parseInt(document.getElementById('personas').value, 10);
            console.log('Número de personas:', numPersonas); // Depuración
            if (numPersonas > 0) {
                // Actualizar el formulario de personas basado en el número de personas seleccionadas
                const formContainer = document.getElementById('step2');
                formContainer.innerHTML = ''; // Limpiar el contenedor

                // Crear los formularios de identidad según el número de personas
                for (let i = 1; i <= numPersonas; i++) {
                    const fieldset = document.createElement('fieldset');
                    const legend = document.createElement('legend');
                    legend.textContent = `Persona ${i}`;
                    fieldset.appendChild(legend);

                    // Añadir los campos del modelo Identidades
                    const fields = [
                        { name: 'tipo_documento', placeholder: 'Tipo de Documento (DNI, Carnet de Conducir, Pasaporte)', type: 'text' },
                        { name: 'numero_documento', placeholder: 'Número de Documento', type: 'text' },
                        { name: 'fecha_expedicion', placeholder: 'Fecha de Expedición', type: 'date' },
                        { name: 'primer_apellido', placeholder: 'Primer Apellido', type: 'text' },
                        { name: 'segundo_apellido', placeholder: 'Segundo Apellido (Opcional)', type: 'text' },
                        { name: 'nombre', placeholder: 'Nombre', type: 'text' },
                        { name: 'sexo', placeholder: 'Sexo (Masculino, Femenino, Otro)', type: 'text' },
                    ];

                    fields.forEach(field => {
                        const input = document.createElement('input');
                        input.name = `${field.name}_${i}`;
                        input.placeholder = field.placeholder;
                        input.type = field.type;
                        input.required = true;
                        fieldset.appendChild(input);
                    });

                    formContainer.appendChild(fieldset);
                }

                // Mostrar el segundo paso
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            } else {
                alert("El número de personas debe ser mayor a 0.");
            }
        });
    });
</script>

{% endblock %}
