{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Reservar Propiedad</h2>
    
    <form id="reservaForm" method="post">
        {% csrf_token %}
        
        <!-- Selección de fechas con Flatpickr -->
        <div class="form-group">
            <label for="fecha_reserva">Selecciona el rango de fechas:</label>
            <input type="text" id="fecha_reserva" name="fecha_reserva" class="form-control" placeholder="Selecciona fechas" required>
        </div>

        <!-- Mostrar el costo total -->
        <div id="costo_total" class="alert alert-info text-center">
            Total: €0.00
        </div>

        <!-- Selección de cantidad de personas -->
        <div class="form-group">
            <label for="cantidadPersonas">Cantidad de personas:</label>
            <input type="number" id="cantidadPersonas" name="cantidad_personas" class="form-control" value="1" min="1" max="20" required>
        </div>

        <!-- Formulario de identidad del usuario -->
        <h3>Información del titular de la reserva</h3>
        <div id="identidadTitular">
            {% if identidad_form %}
                <div id="formBase">
                    {{ identidad_form.as_p }}
                </div>
            {% else %}
                <p>No tienes una identidad registrada. Por favor, completa tu información antes de continuar.</p>
            {% endif %}
        </div>

        <!-- Formularios adicionales para acompañantes -->
        <h3>Información de acompañantes</h3>
        <div id="formulariosAcompanantes"></div>

        <!-- Botón para enviar -->
        <button type="submit" class="btn btn-primary">Reservar</button>
    </form>
</div>

<!-- Incluir Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> <!-- Localización en español -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const precioPorNoche = parseFloat('{{ propiedad.precio_por_noche|default:"100" }}');
        const fechasNoDisponibles = JSON.parse('{{ fechas_no_disponibles_json|escapejs }}');

        // Configuración de Flatpickr
        flatpickr("#fecha_reserva", {
            mode: "range",
            minDate: "today",
            disable: fechasNoDisponibles.map(fecha => new Date(fecha)),
            dateFormat: "Y-m-d",
            locale: "es",
            onChange: function(selectedDates) {
                const costoTotalElement = document.getElementById('costo_total');
                if (selectedDates.length > 1) {
                    const diffDays = Math.ceil((selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24));
                    const total = diffDays * precioPorNoche;
                    costoTotalElement.innerText = `Total: €${total.toFixed(2)}`;
                } else {
                    costoTotalElement.innerText = "Total: €0.00";
                }
            }
        });

        // Manejar dinámicamente los formularios de acompañantes
        document.getElementById('cantidadPersonas').addEventListener('input', function() {
            const cantidad = parseInt(this.value, 10);
            const container = document.getElementById('formulariosAcompanantes');
            const baseForm = document.getElementById('formBase');

            container.innerHTML = ""; // Limpiar formularios existentes

            if (cantidad >= 2 && baseForm) {
                for (let i = 2; i <= cantidad; i++) {
                    // Clonar el formulario del titular
                    const formClone = baseForm.cloneNode(true);
                    formClone.querySelectorAll("label, input, select").forEach((element) => {
                        const attrName = element.getAttribute("name");
                        const attrId = element.getAttribute("id");

                        if (attrName) {
                            // Cambiar el atributo 'name'
                            element.setAttribute("name", attrName.replace("titular", `acompanante_${i}`));
                        }
                        if (attrId) {
                            // Cambiar el atributo 'id'
                            element.setAttribute("id", attrId.replace("titular", `acompanante_${i}`));
                            element.previousElementSibling.setAttribute(
                                "for",
                                attrId.replace("titular", `acompanante_${i}`)
                            );
                        }
                        if (element.tagName === "INPUT" || element.tagName === "SELECT") {
                            element.value = ""; // Limpiar valores
                        }
                    });

                    // Agregar encabezado para el acompañante
                    const title = document.createElement("h4");
                    title.textContent = `Acompañante ${i}`;
                    container.appendChild(title);

                    // Insertar el formulario clonado en el contenedor
                    container.appendChild(formClone);
                }
            }
        });
    });
</script>
{% endblock %}
