{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Reservar Propiedad</h2>
    
    <form id="reservaForm" method="post">
        {% csrf_token %}
        
        <!-- Selección de fechas con Flatpickr -->
        <div class="form-group">
            <label for="fecha_reserva">Selecciona el rango de fechas:</label>
            <input type="text" id="fecha_reserva" name="fecha_reserva" class="form-control" placeholder="Selecciona fechas" required>
        </div>

        <!-- Mostrar el costo total -->
        <div id="costo_total" class="alert alert-info text-center">
            Total: €0.00
        </div>

        <!-- Selección de cantidad de personas -->
        <div class="form-group">
            <label for="cantidadPersonas">Cantidad de personas:</label>
            <input type="number" id="cantidadPersonas" name="cantidad_personas" class="form-control" value="1" min="1" max="20" required>
        </div>

        <!-- Formulario de identidad del usuario -->
        <h3>Información del titular de la reserva</h3>
        <div id="identidadTitular">
            {% if identidad_form %}
                {{ identidad_form.as_p }}
            {% else %}
                <p>No tienes una identidad registrada. Por favor, completa tu información antes de continuar.</p>
            {% endif %}
        </div>

        <!-- Formularios adicionales para acompañantes -->
        <h3>Información de acompañantes</h3>
        <div id="formulariosAcompanantes"></div>

        <!-- Botón para enviar -->
        <button type="submit" class="btn btn-primary">Reservar</button>
    </form>
</div>

<!-- Incluir Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> <!-- Localización en español -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fechas no disponibles en formato JSON
        const fechasNoDisponibles = JSON.parse('{{ fechas_no_disponibles_json|escapejs }}');
        const precioPorNoche = parseFloat('{{ propiedad.precio_por_noche|default:"100" }}');

        // Configurar Flatpickr para el rango de fechas
        flatpickr("#fecha_reserva", {
            mode: "range",
            minDate: "today",
            disable: fechasNoDisponibles.map(fecha => new Date(fecha)),
            dateFormat: "Y-m-d",
            locale: "es",
            onChange: function(selectedDates) {
                if (selectedDates.length > 1) {
                    const start = selectedDates[0];
                    const end = selectedDates[1];

                    // Calcular diferencia en días (no incluye el día de salida)
                    const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                    // Calcular el total
                    const total = diffDays * precioPorNoche;

                    // Actualizar el costo total en el DOM
                    document.getElementById('costo_total').innerText = `Total: €${total.toFixed(2)}`;
                } else {
                    // Si no hay rango válido, mostrar €0.00
                    document.getElementById('costo_total').innerText = "Total: €0.00";
                }
            }
        });

        // Generar formularios de acompañantes dinámicamente
        document.getElementById('cantidadPersonas').addEventListener('input', function() {
            const cantidad = parseInt(this.value, 10);
            const container = document.getElementById('formulariosAcompanantes');
            container.innerHTML = "";

            if (cantidad >= 2) {
                for (let i = 2; i <= cantidad; i++) {
                    const formHtml = `
                        <div class="form-group">
                            <h4>Acompañante ${i}</h4>
                            
                            <label for="tipoDocumento_${i}">Tipo documento:</label>
                            <input type="text" id="tipoDocumento_${i}" name="acompanante_${i}_tipo_documento" class="form-control" required>
                            
                            <label for="numeroDocumento_${i}">Número documento:</label>
                            <input type="text" id="numeroDocumento_${i}" name="acompanante_${i}_numero_documento" class="form-control" required>
                            
                            <label for="fechaExpedicion_${i}">Fecha expedición:</label>
                            <input type="date" id="fechaExpedicion_${i}" name="acompanante_${i}_fecha_expedicion" class="form-control" required>
                            
                            <label for="primerApellido_${i}">Primer apellido:</label>
                            <input type="text" id="primerApellido_${i}" name="acompanante_${i}_primer_apellido" class="form-control" required>
                            
                            <label for="segundoApellido_${i}">Segundo apellido:</label>
                            <input type="text" id="segundoApellido_${i}" name="acompanante_${i}_segundo_apellido" class="form-control">
                            
                            <label for="nombre_${i}">Nombre:</label>
                            <input type="text" id="nombre_${i}" name="acompanante_${i}_nombre" class="form-control" required>
                            
                            <label for="sexo_${i}">Sexo:</label>
                            <select id="sexo_${i}" name="acompanante_${i}_sexo" class="form-control" required>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    `;
                    container.innerHTML += formHtml;
                }
            }
        });
    });
</script>
{% endblock %}
