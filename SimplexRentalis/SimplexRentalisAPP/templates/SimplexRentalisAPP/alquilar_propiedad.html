{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Reservar Propiedad: {{ propiedad.nombre }}</h2>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        
        <!-- Formulario de Reserva -->
        <div class="form-group">
            <label for="fecha_inicio">Fecha de inicio</label>
            {{ form_reserva.fecha_inicio }}
            {% if form_reserva.fecha_inicio.errors %}
            <div class="error">{{ form_reserva.fecha_inicio.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="fecha_fin">Fecha de fin</label>
            {{ form_reserva.fecha_fin }}
            {% if form_reserva.fecha_fin.errors %}
            <div class="error">{{ form_reserva.fecha_fin.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="cantidad_personas">Cantidad de personas</label>
            <input type="number" id="id_cantidad_personas" name="cantidad_personas" min="1" max="{{ propiedad.capacidad_maxima }}" value="1" oninput="validateCantidadPersonas(this);" />
            {% if form_reserva.cantidad_personas.errors %}
            <div class="error">{{ form_reserva.cantidad_personas.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="mascotas">¿Llevarás mascotas?</label>
            {{ form_reserva.mascotas }}
            {% if form_reserva.mascotas.errors %}
            <div class="error">{{ form_reserva.mascotas.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="tipo_mascota">Tipo de mascota (si aplica)</label>
            {{ form_reserva.tipo_mascota }}
            {% if form_reserva.tipo_mascota.errors %}
            <div class="error">{{ form_reserva.tipo_mascota.errors }}</div>
            {% endif %}
        </div>

        <!-- Formulario de Identidad del Usuario -->
        <h3>Datos de Identidad del Usuario</h3>
        {{ form_identidad.as_p }}
        {% if form_identidad.non_field_errors %}
        <div class="error">{{ form_identidad.non_field_errors }}</div>
        {% endif %}

        <!-- Formulario de Identidades de los Acompañantes -->
        <h3>Datos de Identidad de los Acompañantes</h3>
        <div id="acompanantes-container">
            {{ formset_identidades.management_form }}
            {% for form in formset_identidades %}
                <div class="acompanante-form" style="display: none;">
                    {{ form.as_p }}
                    {% if form.non_field_errors %}
                    <div class="error">{{ form.non_field_errors }}</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary">Reservar</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cantidadPersonasField = document.querySelector('#id_cantidad_personas');
        const acompanantesContainer = document.getElementById('acompanantes-container');
        const formsets = document.querySelectorAll('.acompanante-form');

        // Mostrar el número correcto de formularios de acompañantes al cargar la página
        const initialCantidad = parseInt(cantidadPersonasField.value) || 1;
        formsets.forEach((formset, index) => {
            formset.style.display = index < initialCantidad - 1 ? 'block' : 'none';
        });

        // Actualizar los formularios de acompañantes cuando cambia la cantidad de personas
        cantidadPersonasField.addEventListener('change', function() {
            const cantidad = parseInt(cantidadPersonasField.value) || 1;
            formsets.forEach((formset, index) => {
                formset.style.display = index < cantidad - 1 ? 'block' : 'none';
            });
        });
    });

    function validateCantidadPersonas(input) {
        const min = parseInt(input.min);
        const max = parseInt(input.max);
        let value = parseInt(input.value);

        if (isNaN(value) || value < min) {
            input.value = min;
        } else if (value > max) {
            input.value = max;
        }
    }
</script>

{% endblock %}
