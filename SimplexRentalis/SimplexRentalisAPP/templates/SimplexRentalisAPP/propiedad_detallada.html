{% extends 'base.html' %}
{% load static %}
{% block title %}
Propiedad en detalle
{% endblock %}

{% block content %}
<div id="main-content" style="max-width: 1200px; margin: auto; font-family: Arial, sans-serif; padding: 20px;">
    <h1 class="propiedad-title" style="text-align: center; margin-bottom: 20px; font-size: 2.5em; color: #333;">{{ propiedades.nombre }}</h1>

    <div class="detalle-container" style="display: flex; gap: 20px; margin-bottom: 40px;">
        <!-- Sección de la Imagen Principal -->
        <div class="propiedad-image" style="flex: 3; position: relative;">
            <div class="image-navigation" style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); z-index: 10;">
                <!-- Flecha izquierda -->
                <span class="arrow left-arrow" onclick="changeImageByArrow('prev')" style="cursor: pointer;">
                    <img src="{% static 'defaults/flecha-izquierda.png' %}" alt="Flecha Izquierda" style="width: 50px; opacity: 0.7; filter: drop-shadow(2px 2px 4px #444);">
                </span>
            </div>

            {% if imagen_portada %}
                <img src="{{ imagen_portada.imagen.url }}" alt="Imagen de Portada" class="img-fluid main-image" id="main-image" 
                     style="width: 100%; height: 400px; border-radius: 10px; object-fit: cover;" 
                     onclick="changeImage('{{ imagen_portada.imagen.url }}', this)">
            {% else %}
                <div class="no-imagen" style="text-align: center; font-size: 18px; color: gray; border: 1px solid #ccc; padding: 20px; border-radius: 10px;">
                    No hay imagen de portada disponible.
                </div>
            {% endif %}

            <!-- Contenedor de las miniaturas -->
            <div class="thumbnails-container" style="display: flex; gap: 10px; margin-top: 10px; overflow-x: auto;">
                {% for imagen in imagenes %}
                    <img src="{{ imagen.imagen.url }}" alt="{{ imagen.descripcion }}" class="thumbnail-image" 
                         style="width: 100px; height: 60px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid transparent;" 
                         onclick="changeImage('{{ imagen.imagen.url }}', this)">
                {% endfor %}
            </div>

            <div class="image-navigation" style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); z-index: 10;">
                <!-- Flecha derecha -->
                <span class="arrow right-arrow" onclick="changeImageByArrow('next')" style="cursor: pointer;">
                    <img src="{% static 'defaults/flecha-derecha.png' %}" alt="Flecha Derecha" style="width: 50px; opacity: 0.7; filter: drop-shadow(2px 2px 4px #444);">
                </span>
            </div>
        </div>

        <!-- Nombre de la Propiedad y Botón Alquilar -->
        <div class="propiedad-summary" style="flex: 2; background-color: #f9f9f9; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-top: 0; color: #333; font-size: 2em;">{{ propiedades.nombre }}</h2>
            <p><strong>Precio por noche:</strong> <span style="color: #007bff; font-size: 1.5em; font-weight: bold;">{{ propiedades.precio_noche }} €</span></p>
            <p><strong>Calificación:</strong> 
                <span style="color: #f0ad4e; font-size: 1.5em;">⭐{{ propiedades.calificacion }}</span>
            </p>
            <p><strong>Dirección:</strong> {{ propiedades.direccion }}</p>
            <p><strong>Capacidad máxima:</strong> {{ propiedades.capacidad_maxima }} personas</p>
            <p><strong>Baños:</strong> {{ propiedades.cantidad_banos }}</p>
            <p><strong>Dormitorios:</strong> {{ propiedades.cantidad_dormitorios }}</p>
            <p><strong>Permite mascotas:</strong> {{ propiedades.permite_mascotas|yesno:"Sí,No" }}</p>

            {% if request.user == propiedades.propietario %}
                <!-- Si el usuario es el propietario, no mostrar el botón -->
                <p style="color: #6c757d;">Eres el propietario de esta propiedad.</p>
            {% else %}
                <!-- Si no estás logueado, muestra un mensaje invitando a iniciar sesión -->
                {% if not request.user.is_authenticated %}
                    <p style="color: #dc3545;">Para alquilar esta propiedad, por favor inicia sesión.</p>
                {% endif %}
                <form action="{% url 'alquilar_propiedad' propiedades.id %}" method="get" style="display: inline;">
                    <button type="submit" class="btn btn-primary alquilar-btn" 
                            style="background-color: #007bff; color: white; border: none; padding: 10px 20px; font-size: 1.2em; cursor: pointer; border-radius: 5px;">
                        ALQUILAR
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Botón para bajar a la descripción (fijo) -->
    <div class="explore-button" id="explore-button" style="position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 1000;">
        <button onclick="scrollToDescription()" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; font-size: 1em; cursor: pointer; border-radius: 5px;">
            Descubre más detalles
        </button>
    </div>    

    <!-- Descripción Debajo de la Imagen -->
    <div class="descripcion-container" id="descripcion" style="margin-bottom: 40px;">
        <h3>Descripción</h3>
        <p style="line-height: 1.6; font-size: 1.1em; color: #666;">{{ propiedades.descripcion }}</p>
    </div>

    <!-- Apartado de Contacto -->
    <div class="contacto-container" style="background-color: #f1f1f1; padding: 20px; border-radius: 10px; margin-bottom: 40px;">
        <h3>Contacto</h3>
        <div style="display: flex; align-items: center;">
            <img src="{% if propiedades.propietario.avatar %}{{ propiedades.propietario.avatar.url }}{% else %}/media/defaults/default_avatar.png{% endif %}" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 20px;">
            <div>
                <p><strong>Dueño:</strong> {{ propiedades.propietario.username }}</p>
                <p><strong>Teléfono:</strong> {{ propiedades.propietario.telefono }}</p>
                <p><strong>Correo electrónico:</strong> {{ propiedades.propietario.email }}</p>
            </div>
        </div>
    </div>

    <!-- Sección de Opiniones -->
    <div class="opiniones-container" style="margin-bottom: 40px;">
        <h3>Opiniones</h3>
        {% for opinion in propiedades.opiniones_set.all %}
            <div class="opinion" style="background-color: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);">
                <strong>{{ opinion.usuario }}:</strong>
                <p>{{ opinion.comentario }}</p>
                <p><strong>Calificación:</strong> <span style="color: #f0ad4e;">⭐{{ opinion.calificacion }}</span></p>
            </div>
        {% empty %}
            <p>No hay opiniones disponibles.</p>
        {% endfor %}
    </div>

    <div class="back-link" style="text-align: center;">
        <a href="{% url 'propiedades' %}" class="btn" style="background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">Volver a la lista de propiedades</a>
    </div>
</div>

<script>
    let currentImageIndex = 0; // Índice de la imagen actual

    // Cambia la imagen principal
    function changeImage(imageUrl, thumbnailElement) {
        const mainImage = document.getElementById('main-image');
        mainImage.src = imageUrl;

        // Actualizar el índice de la imagen principal
        const thumbnails = document.querySelectorAll('.thumbnail-image');
        thumbnails.forEach(thumb => thumb.style.border = '2px solid transparent'); // Elimina la clase activa de todas las miniaturas
        thumbnailElement.style.border = '2px solid #007bff'; // Añade borde a la miniatura seleccionada
    }

    // Cambiar imagen con las flechas
    function changeImageByArrow(direction) {
        const images = document.querySelectorAll('.thumbnail-image');
        if (direction === 'next') {
            currentImageIndex = (currentImageIndex + 1) % images.length; // Ir a la siguiente imagen
        } else if (direction === 'prev') {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length; // Ir a la imagen anterior
        }
        const newImage = images[currentImageIndex];
        changeImage(newImage.src, newImage); // Cambia la imagen principal al hacer clic en las flechas
    }

    // Función para desplazarse a la descripción
    function scrollToDescription() {
        const descriptionElement = document.getElementById('descripcion');
        window.scrollTo({
            top: descriptionElement.offsetTop - 20, // Ajustar la posición según sea necesario
            behavior: 'smooth'
        });

        // Desvanecer el botón después de hacer clic
        const exploreButton = document.getElementById('explore-button');
        exploreButton.style.transition = 'opacity 0.5s';
        exploreButton.style.opacity = '0';
        setTimeout(() => {
            exploreButton.style.display = 'none';
        }, 500); // Eliminar el botón después de la transición
    }
</script>
{% endblock %}
