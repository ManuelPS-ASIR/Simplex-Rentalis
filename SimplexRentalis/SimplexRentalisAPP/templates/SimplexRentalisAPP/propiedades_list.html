{% extends 'base.html' %}
{% load static %}

{% block title %}
    Lista de Propiedades
{% endblock %}

{% block content %}
<style>
/* Estilos específicos para la barra lateral y los filtros */
.fixed-left {
    position: fixed;
    left: 0;
    top: 60px; /* Ajuste para no superponer con el navbar */
    height: calc(100vh - 60px); /* Mantiene la altura dinámica */
    z-index: 1000;
    overflow-y: auto;
    background-color: #333;
    color: #fff;
    padding: 20px;
    box-sizing: border-box;
}

.fixed-left input[type="text"], 
.fixed-left input[type="number"], 
.fixed-left select {
    width: 100%; /* Ocupa todo el ancho del contenedor */
    padding: 4px; /* Reducido para hacerlos más pequeños */
    margin: 5px 0; /* Reducido para hacerlos más pequeños */
    box-sizing: border-box;
    background-color: #fff;
    color: #333;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.fixed-left label {
    font-size: 14px; /* Tamaño original */
    margin-bottom: 5px;
    display: block;
}

.fixed-left button {
    width: 100%;
    padding: 8px; /* Reducido para hacerlos más pequeños */
    margin-top: 10px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.fixed-left button:hover {
    background-color: #0056b3; /* Efecto hover */
}

/* CSS específico para la barra de filtro de precios */
.slider-container {
    width: 100%; /* Ocupa todo el ancho */
    margin: 10px 0; /* Reducido para hacerlos más pequeños */
}

.range-slider {
    position: relative;
    width: 100%;
    height: 8px;
    background: #ddd;
    margin-bottom: 20px; /* Ajustado para evitar solapamientos */
}

.range-slider input[type="range"] {
    position: absolute;
    width: 100%;
    height: 8px;
    background: none;
    pointer-events: none;
    -webkit-appearance: none;
    z-index: 2;
}

.range-slider input[type="range"]::-webkit-slider-thumb {
    pointer-events: auto;
    position: relative;
    z-index: 3;
    -webkit-appearance: none;
    appearance: none;
    width: 16px; /* Reducido para hacerlos más pequeños */
    height: 16px; /* Reducido para hacerlos más pequeños */
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
}

.range-slider input[type="range"]::-moz-range-thumb {
    pointer-events: auto;
    position: relative;
    z-index: 3;
    width: 16px; /* Reducido para hacerlos más pequeños */
    height: 16px; /* Reducido para hacerlos más pequeños */
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
}

.range-slider input[type="range"].thumb-lower::-webkit-slider-thumb {
    z-index: 4;
}

.range-slider input[type="range"].thumb-lower::-moz-range-thumb {
    z-index: 4;
}

.price-range {
    display: flex;
    justify-content: space-between;
    margin-top: 10px; /* Espaciado adicional para evitar solapamientos */
}

.price-range input {
    width: 45%; /* Distribución pareja */
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 3px; /* Reducido para hacerlos más pequeños */
    position: relative; /* Añadido para contener el span */
}

.price-range span {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* El span no interferirá con la entrada de texto */
    color: #000;
}

/* Desactivar animaciones en la card de filtros */
.no-animation {
    opacity: 1; /* Asegúrate de que la card esté completamente visible sin animación */
    transition: none !important; /* Desactiva todas las transiciones */
}

.no-animation:hover {
    transform: none !important; /* Asegúrate de que no haya transformaciones al pasar el ratón */
    transition: none !important; /* Desactiva las transiciones en el estado de hover */
}
</style>

<div class="container mt-5">
    <div class="row">
        <!-- Filtro de propiedades (columna izquierda) -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-3 p-3 fixed-left no-animation">
                <h5 class="card-title">Filtros</h5>
                <form id="filtroForm" method="get" action="{% url 'propiedades' %}">
                    <!-- Dirección o lugar -->
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección o lugar</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Ej: Madrid" value="{{ request.GET.direccion }}">
                    </div>
                    
                    <!-- Filtro de precio -->
                    <div class="slider-container">
                        <label for="priceRange" class="form-label">Precio</label>
                        <div class="range-slider">
                            <input type="range" id="minPrice" name="precio_min" min="{{ precio_minimo }}" max="{{ precio_maximo }}" 
                            value="{{ request.GET.precio_min|default:precio_minimo }}" oninput="updatePriceValues()" class="slider thumb-lower">
                            <input type="range" id="maxPrice" name="precio_max" min="{{ precio_minimo }}" max="{{ precio_maximo }}" 
                            value="{{ request.GET.precio_max|default:precio_maximo }}" oninput="updatePriceValues()" class="slider">
                        </div>
                        <div class="price-range">
                            <div style="position: relative; width: 45%;">
                                <input type="text" id="minPriceValue" value="{{ request.GET.precio_min|default:precio_minimo }}" readonly>
                                <span>€</span>
                            </div>
                            <div style="position: relative; width: 45%;">
                                <input type="text" id="maxPriceValue" value="{{ request.GET.precio_max|default:precio_maximo }}" readonly>
                                <span>€</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calificación mínima -->
                    <div class="mb-3">
                        <label for="calificacion" class="form-label">Calificación mínima</label>
                        <select class="form-control" id="calificacion" name="calificacion">
                            <option value="">Seleccionar</option>
                            {% for i in "12345" %}
                                <option value="{{ i }}" {% if i == request.GET.calificacion %}selected{% endif %}>{{ i }} estrellas</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Permite mascotas -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="permite_mascotas" name="permite_mascotas" {% if request.GET.permite_mascotas %}checked{% endif %}>
                        <label class="form-check-label" for="permite_mascotas">Permite mascotas</label>
                    </div>

                    <!-- Capacidad máxima -->
                    <div class="mb-3">
                        <label for="capacidad_maxima" class="form-label">Capacidad máxima</label>
                        <input type="number" class="form-control" id="capacidad_maxima" name="capacidad_maxima" placeholder="0" value="{{ request.GET.capacidad_maxima }}">
                    </div>

                    <!-- Botones de filtros -->
                    <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
                    <button type="button" class="btn btn-secondary w-100 mt-3" id="eliminarFiltrosBtn">Eliminar Filtros</button>
                </form>
            </div>
        </div>
        
        <!-- Contenedor de propiedades (columna derecha) -->
        <div class="col-md-9">
            <div class="position-relative mb-4">
                <h2 class="text-center m-0">Descubre tu próximo destino</h2>
            </div>

            <div class="row justify-content-center">
                {% if propiedades %}
                    {% for propiedad in propiedades %}
                    <div class="col-12 col-md-6 col-lg-4 mb-4 d-flex align-items-stretch">
                        <div class="propiedad-card-wrapper position-relative">
                            <a href="{% url 'propiedad_detallada' propiedad.pk %}" class="text-decoration-none">
                                <div class="card propiedad-card shadow-sm rounded-3 overflow-hidden" style="height: 100%; display: flex; flex-direction: column;">
                                    <!-- Imagen de la propiedad -->
                                    <div class="card-image" style="height: 200px; overflow: hidden;">
                                        <img src="{{ propiedad.portada }}" class="img-fluid rounded-top" alt="Imagen de {{ propiedad.nombre }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    
                                    <!-- Detalles de la propiedad -->
                                    <div class="card-body p-4" style="flex-grow: 1;">
                                        <h5 class="card-title text-truncate">{{ propiedad.nombre }} - <span class="text-primary">{{ propiedad.precio_noche }}€</span></h5>
                                        <p class="card-text text-muted text-truncate">{{ propiedad.direccion }}</p>
                                        <p class="text-muted">
                                            {{ propiedad.calificacion|default:"-" }}
                                            <span class="stars">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= propiedad.calificacion %}
                                                        <i class="fas fa-star"></i>
                                                    {% else %}
                                                        <i class="far fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-muted">No hay propiedades que coincidan con los filtros.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const gap = 4; // Espacio mínimo en unidades entre los sliders
    let typingTimer; // Timer para detectar cuando el usuario deja de escribir
    const doneTypingInterval = 1000; // Intervalo de tiempo en milisegundos (1 segundo)
    let lastModifiedBy = 'sliders'; // Variable para rastrear la última interacción del usuario

    // Función para actualizar los valores de los inputs con los valores actuales de los sliders
    function updatePriceValuesFromSliders() {
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const minPriceValue = document.getElementById('minPriceValue');
        const maxPriceValue = document.getElementById('maxPriceValue');

        // Actualizar los valores de los inputs con los valores actuales de los sliders
        minPriceValue.value = minPrice.value;
        maxPriceValue.value = maxPrice.value;

        // Calcular el porcentaje de posición del slider basado en el valor
        const minPricePercentage = ((minPrice.value - precioMinimoBD) / (precioMaximoBD - precioMinimoBD)) * 100;
        const maxPricePercentage = ((maxPrice.value - precioMinimoBD) / (precioMaximoBD - precioMinimoBD)) * 100;

        // Actualizar el fondo del slider para simular el movimiento de los "thumbs"
        minPrice.style.backgroundSize = `${minPricePercentage}% 100%`;
        maxPrice.style.backgroundSize = `${maxPricePercentage}% 100%`;
    }

    // Función para actualizar los sliders desde los inputs después de que el usuario deja de escribir
    function updateSlidersFromInputs() {
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const minPriceValue = document.getElementById('minPriceValue');
        const maxPriceValue = document.getElementById('maxPriceValue');

        // Convertir valores de las casillas de texto a números
        const minPriceVal = parseInt(minPriceValue.value.trim()) || precioMinimoBD;
        const maxPriceVal = parseInt(maxPriceValue.value.trim()) || precioMaximoBD;

        // Validar y ajustar los valores para evitar superposición
        if (minPriceVal + gap > maxPriceVal) {
            minPrice.value = maxPriceVal - gap;
        } else if (maxPriceVal - gap < minPriceVal) {
            maxPrice.value = minPriceVal + gap;
        } else {
            minPrice.value = minPriceVal;
            maxPrice.value = maxPriceVal;
        }

        // Asegurarse de que los sliders reflejan los valores actualizados
        updatePriceValuesFromSliders();
    }

    // Función para aplicar las validaciones después de que el usuario deja de escribir
    function doneTyping() {
        if (lastModifiedBy === 'inputs') {
            updateSlidersFromInputs();
        }
    }

    // Eventos para los deslizadores
    document.getElementById('minPrice').addEventListener('input', function () {
        lastModifiedBy = 'sliders';
        clearTimeout(typingTimer);
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');

        // Validar que no haya superposición
        if (parseInt(minPrice.value) + gap > parseInt(maxPrice.value)) {
            minPrice.value = parseInt(maxPrice.value) - gap;
        }
        updatePriceValuesFromSliders();
    });

    document.getElementById('maxPrice').addEventListener('input', function () {
        lastModifiedBy = 'sliders';
        clearTimeout(typingTimer);
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');

        // Validar que no haya superposición
        if (parseInt(maxPrice.value) - gap < parseInt(minPrice.value)) {
            maxPrice.value = parseInt(minPrice.value) + gap;
        }
        updatePriceValuesFromSliders();
    });

    // Eventos para las casillas de texto (entrada manual)
    document.getElementById('minPriceValue').addEventListener('input', function () {
        lastModifiedBy = 'inputs';
        clearTimeout(typingTimer);
        typingTimer = setTimeout(doneTyping, doneTypingInterval);
    });

    document.getElementById('maxPriceValue').addEventListener('input', function () {
        lastModifiedBy = 'inputs';
        clearTimeout(typingTimer);
        typingTimer = setTimeout(doneTyping, doneTypingInterval);
    });

    // Capturar el clic en el botón "Eliminar Filtros" y restablecer los valores
    document.getElementById('eliminarFiltrosBtn').addEventListener('click', function () {
        // Restablecer los valores del formulario
        document.getElementById('filtroForm').reset();

        // Restaurar valores predeterminados del rango de precios
        document.getElementById('minPrice').value = precioMinimoBD;
        document.getElementById('maxPrice').value = precioMaximoBD;
        updatePriceValuesFromSliders();

        // Eliminar los parámetros de búsqueda de la URL
        const url = new URL(window.location.href);
        url.search = ""; // Quitar todos los parámetros
        window.history.pushState({}, '', url); // Actualizar la URL sin recargar la página

        // Recargar la página sin filtros aplicados
        window.location.reload();
    });

    // Configuración inicial
    const precioMaximoBD = 10000; // Cambia este valor según el precio máximo en tu base de datos
    const precioMinimoBD = 0; // Cambia este valor según el precio máximo en tu base de datos
    document.getElementById('minPrice').value = precioMinimoBD;
    document.getElementById('maxPrice').value = precioMaximoBD;
    updatePriceValuesFromSliders();
</script>

{% endblock %}
