{% extends 'base.html' %}
{% load static %}

{% block title %}
    Lista de Propiedades
{% endblock %}

{% block content %}
<style>
/* Estilos específicos para la barra lateral y los filtros */
.fixed-left {
    position: fixed;
    left: 0;
    top: 60px; /* Ajuste para no superponer con el navbar */
    height: calc(100vh - 60px); /* Mantiene la altura dinámica */
    z-index: 1000;
    overflow-y: auto;
    background-color: #333;
    color: #fff;
    padding: 20px;
    box-sizing: border-box;
}

.fixed-left input[type="text"], 
.fixed-left input[type="number"], 
.fixed-left select {
    width: 100%; /* Ocupa todo el ancho del contenedor */
    padding: 8px;
    margin: 10px 0;
    box-sizing: border-box;
    background-color: #fff;
    color: #333;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.fixed-left label {
    font-size: 14px; /* Tamaño ajustado */
    margin-bottom: 5px;
    display: block;
}

.fixed-left button {
    width: 100%;
    padding: 10px;
    margin-top: 20px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.fixed-left button:hover {
    background-color: #0056b3; /* Efecto hover */
}

/* CSS específico para la barra de filtro de precios */
.slider-container {
    width: 100%; /* Ocupa todo el ancho */
    margin: 20px 0;
}

.range-slider {
    position: relative;
    width: 100%;
}

.slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: #ddd;
    outline: none;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #007bff;
    border-radius: 50%; /* Pulgar redondo */
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
}

.price-range {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.price-range input {
    width: 45%; /* Distribución pareja */
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px;
}
</style>

<div class="container mt-5">
    <div class="row">
        <!-- Filtro de propiedades (columna izquierda) -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-3 p-3 fixed-left">
                <h5 class="card-title">Filtros</h5>
                <form id="filtroForm" method="get" action="{% url 'propiedades' %}">
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección o lugar</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Ej: Madrid">
                    </div>
                    <div class="slider-container">
                        <label for="minPrice" class="form-label">Precio</label>
                        <div class="range-slider">
                            <input type="range" id="minPrice" name="precio_min" min="0" max="10000" value="0" oninput="updatePriceValues()" class="slider">
                            <input type="range" id="maxPrice" name="precio_max" min="0" max="10000" value="10000" oninput="updatePriceValues()" class="slider">
                            <div class="price-range">
                                <input type="text" id="minPriceValue" value="0€" readonly>
                                <input type="text" id="maxPriceValue" value="10000€" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="calificacion" class="form-label">Calificación mínima</label>
                        <select class="form-control" id="calificacion" name="calificacion">
                            <option value="">Seleccionar</option>
                            {% for i in "12345" %}
                                <option value="{{ i }}">{{ i }} estrellas</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="permite_mascotas" name="permite_mascotas">
                        <label class="form-check-label" for="permite_mascotas">Permite mascotas</label>
                    </div>
                    <div class="mb-3">
                        <label for="capacidad_maxima" class="form-label">Capacidad máxima</label>
                        <input type="number" class="form-control" id="capacidad_maxima" name="capacidad_maxima" placeholder="0">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
                    <!-- Botón Eliminar Filtros -->
                    <button type="button" class="btn btn-secondary w-100 mt-3" id="eliminarFiltrosBtn">Eliminar Filtros</button>
                </form>
            </div>
        </div>

        <!-- Contenedor de propiedades (columna derecha) -->
        <div class="col-md-9">
            <div class="position-relative mb-4">
                <h2 class="text-center m-0">Descubre tu próximo destino</h2>
            </div>

            <div class="row justify-content-center">
                {% if propiedades %}
                    {% for propiedad in propiedades %}
                    <div class="col-12 col-md-6 col-lg-4 mb-4 d-flex align-items-stretch">
                        <div class="propiedad-card-wrapper position-relative">
                            <a href="{% url 'propiedad_detallada' propiedad.pk %}" class="text-decoration-none">
                                <div class="card propiedad-card shadow-sm rounded-3 overflow-hidden" style="height: 100%; display: flex; flex-direction: column;">
                                    <div class="card-image" style="height: 200px; overflow: hidden;">
                                        <img src="{{ propiedad.portada }}" class="img-fluid rounded-top" alt="Imagen de {{ propiedad.nombre }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div class="card-body p-4" style="flex-grow: 1;">
                                        <h5 class="card-title text-truncate">{{ propiedad.nombre }} - <span class="text-primary">{{ propiedad.precio_noche }}€</span></h5>
                                        <p class="card-text text-muted text-truncate">{{ propiedad.direccion }}</p>
                                        <p class="text-muted">
                                            {{ propiedad.calificacion|default:"-" }}
                                            <span class="stars">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= propiedad.calificacion %}
                                                        <i class="fas fa-star"></i>
                                                    {% else %}
                                                        <i class="far fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-muted">No hay propiedades que coincidan con los filtros.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Función para actualizar los valores de precio
    function updatePriceValues() {
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const minPriceValue = document.getElementById('minPriceValue');
        const maxPriceValue = document.getElementById('maxPriceValue');

        // Actualizar los valores de los inputs
        minPriceValue.value = `${minPrice.value}€`;
        maxPriceValue.value = `${maxPrice.value}€`;
    }

    // Agregar eventos a los sliders y asegurar que se mantienen dentro de sus límites
    document.getElementById('minPrice').addEventListener('input', function() {
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        if (parseInt(minPrice.value) > parseInt(maxPrice.value)) {
            minPrice.value = maxPrice.value;
        }
        updatePriceValues();
    });

    document.getElementById('maxPrice').addEventListener('input', function() {
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        if (parseInt(maxPrice.value) < parseInt(minPrice.value)) {
            maxPrice.value = minPrice.value;
        }
        updatePriceValues();
    });

    // Capturar el clic en el botón "Eliminar Filtros" y restablecer los filtros
    document.getElementById('eliminarFiltrosBtn').addEventListener('click', function() {
        // Limpiar los valores del formulario
        document.getElementById('filtroForm').reset();

        // Restaurar los valores predeterminados del rango de precios
        document.getElementById('minPrice').value = 0;
        document.getElementById('maxPrice').value = 10000;
        updatePriceValues();

        // Eliminar los parámetros de la URL (filtros)
        const url = new URL(window.location.href);
        url.search = ""; // Elimina todos los parámetros de búsqueda
        window.history.pushState({}, '', url); // Actualiza la URL sin recargar la página

        // Recargar la página sin los filtros aplicados
        window.location.reload();
    });

</script>

{% endblock %}
