{% extends "base.html" %}

{% block title %}Configuración de Cuenta{% endblock %}

{% load static %}

{% block content %}

<div class="container mt-5">
    <h1 class="text-center">Configuración de Cuenta</h1>
    <hr>

    <!-- Detalles del Usuario -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h3>Información de {{ user.username }}</h3>
        </div>
        <div class="card-body">
            <p><strong>Nombre de usuario:</strong> {{ user.username }}</p>
            <p><strong>Correo electrónico:</strong> {{ user.email }}</p>
            <p><strong>Fecha de registro:</strong> {{ user.date_joined|date:"d M Y" }}</p>
        </div>
    </div>

    <!-- Actualizar Contraseña -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h3>Actualizar Contraseña</h3>
        </div>
        <div class="card-body">
            <p>Puedes actualizar tu contraseña desde aquí:</p>
            <a href="{% url 'password_change' %}" class="btn btn-warning">Cambiar contraseña</a>
        </div>
    </div>

    <!-- Actualizar Perfil -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h3>Actualizar Perfil</h3>
        </div>
        <div class="card-body">
            <form id="settingsForm" method="post" enctype="multipart/form-data" action="{% url 'settings' %}">
                {% csrf_token %}
                <!-- campos del formulario -->
        
                <div class="mb-3">
                    <label for="username" class="form-label">Nombre de usuario</label>
                    <input type="text" class="form-control {% if form.username.errors %}is-invalid{% endif %}" id="username" name="username" value="{{ form.username.value|default:user.username }}" required>
                    <div class="invalid-feedback">
                        {% for error in form.username.errors %}{{ error }}{% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="telefono" class="form-label">Teléfono</label>
                    <div class="input-group">
                        <span class="input-group-text">+34</span>
                        <input type="tel" class="form-control {% if form.telefono.errors %}is-invalid{% endif %}" id="telefono" name="telefono" value="{{ form.telefono.value|default:user.telefono }}" required maxlength="9" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        <div class="invalid-feedback">
                            {% for error in form.telefono.errors %}{{ error }}{% endfor %}
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="fecha_nacimiento" class="form-label">Fecha de nacimiento</label>
                    <input type="date" class="form-control {% if form.fecha_nacimiento.errors %}is-invalid{% endif %}" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ form.fecha_nacimiento.value|default:user.fecha_nacimiento|date:'Y-m-d' }}" required>
                    <div class="invalid-feedback">
                        {% for error in form.fecha_nacimiento.errors %}{{ error }}{% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="genero" class="form-label">Género</label>
                    <select class="form-control {% if form.genero.errors %}is-invalid{% endif %}" id="genero" name="genero" required>
                        <option value="" {% if form.genero.value == "" or user.genero == "" %}selected{% endif %}>Seleccionar género</option>
                        <option value="masculino" {% if form.genero.value == "masculino" or user.genero == "masculino" %}selected{% endif %}>Masculino</option>
                        <option value="femenino" {% if form.genero.value == "femenino" or user.genero == "femenino" %}selected{% endif %}>Femenino</option>
                        <option value="otro" {% if form.genero.value == "otro" or user.genero == "otro" %}selected{% endif %}>Otro</option>
                    </select>
                    <div class="invalid-feedback">
                        {% for error in form.genero.errors %}{{ error }}{% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="avatar" class="form-label">Imagen de Perfil</label>
                    <input type="file" class="form-control {% if form.avatar.errors %}is-invalid{% endif %}" id="avatar" name="avatar">
                    <div class="invalid-feedback">
                        {% for error in form.avatar.errors %}{{ error }}{% endfor %}
                    </div>
                </div>
                <button id="updateProfileBtn" type="submit" class="btn btn-info">Actualizar Perfil</button>
                <span id="timer" style="margin-left: 10px; font-weight: bold; color: red;"></span> <!-- Contador -->
            </form>
        </div>
    </div>

    <!-- Eliminar Cuenta -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <h3>Eliminar Cuenta</h3>
        </div>
        <div class="card-body">
            <p>¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.</p>
            <form method="post" action="{% url 'delete_account' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.');">Eliminar Cuenta</button>
            </form>
        </div>
    </div>
</div>

<!-- Toast para mostrar éxito -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast align-items-center text-bg-success border-0 custom-toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                ¡Los cambios se realizaron con éxito!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
    // Función para mostrar errores de validación
    function showErrors(form, errors) {
        form.querySelectorAll('.is-invalid').forEach(function(element) {
            element.classList.remove('is-invalid');
        });

        form.querySelectorAll('.invalid-feedback').forEach(function(element) {
            element.textContent = ''; // Limpiar mensajes de error anteriores
        });

        for (const [field, message] of Object.entries(errors)) {
            const input = form.querySelector(`[name=${field}]`);
            if (input) {
                input.classList.add('is-invalid');
                input.nextElementSibling.textContent = message;
            }
        }
    }

    // Manejo de errores para el formulario de configuración
    document.getElementById("settingsForm").addEventListener("submit", function(e) {
        e.preventDefault();  // Prevenir el envío del formulario inicialmente

        const form = this;
        const formData = new FormData(form);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Deshabilitar el botón de actualización y activar el contador
        const updateButton = document.getElementById('updateProfileBtn');
        const timerElement = document.getElementById('timer');
        let remainingTime = 180; // 3 minutos en segundos

        // Deshabilitar el botón y mostrar el contador
        updateButton.disabled = true;
        updateButton.textContent = "Bloqueado...";
        timerElement.textContent = `Tiempo restante: ${remainingTime}s`;

        // Actualizar el contador cada segundo
        const interval = setInterval(function() {
            remainingTime--;
            timerElement.textContent = `Tiempo restante: ${remainingTime}s`;

            // Cuando el tiempo llegue a 0, habilitar el botón
            if (remainingTime <= 0) {
                clearInterval(interval);
                updateButton.disabled = false;  // Habilitar el botón
                updateButton.textContent = "Actualizar Perfil";  // Restablecer texto
                timerElement.textContent = '';  // Limpiar el contador
            }
        }, 1000);

        // Añadir el CSRF token
        formData.append('csrfmiddlewaretoken', csrfToken);

        // Enviar el formulario a través de fetch
        fetch("{% url 'settings' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar el toast de éxito
                const toastElement = document.getElementById('successToast');
                const toast = new bootstrap.Toast(toastElement);
                toast.show();

                // Opcional: recargar después de un tiempo
                setTimeout(() => {
                    location.reload();
                }, 180000);
            } else {
                showErrors(form, data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

</script>

{% endblock %}
