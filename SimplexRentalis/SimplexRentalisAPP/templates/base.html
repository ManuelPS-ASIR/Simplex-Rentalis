<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% load static %}
  <title>{% block title %}Página{% endblock %}</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Enlace al archivo CSS dentro de la carpeta static -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

  <!-- Menú de la hamburguesa en el lateral -->
  <div id="menu">
    <span class="hamburguesa">&#9776;</span> <!-- Ícono de hamburguesa -->
    <a href="#" class="menu-item">Mis reservas</a>
    <a href="mis_propiedades/" class="menu-item">Mis propiedades</a>
    <a href="#" class="menu-item">Inicio</a>
    <a href="#" class="menu-item">Servicios</a>
    <a href="#" class="menu-item">Acerca de</a>
    <a href="#" class="menu-item">Contacto</a>
  </div>

  <!-- Barra superior fija -->
  <div class="navbar">
    <div class="container-fluid">
      <!-- Verificamos si el usuario está autenticado -->
      <div id="userMenu" class="position-relative">
        {% if user.is_authenticated %}
        <!-- Si está autenticado, mostramos su nombre y avatar con un dropdown -->
        <a href="#" class="d-flex align-items-center" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
          <span class="text-light">{{ user.username }}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
          <li><a class="dropdown-item" href="{% url 'account_settings' %}">Configuración de la cuenta</a></li>
        </ul>
        {% else %}
        <!-- Si no está autenticado, mostramos el botón de Iniciar sesión -->
        <button class="btn btn-outline-light btn-login" data-bs-toggle="modal" data-bs-target="#loginModal">Iniciar Sesión</button>
        {% endif %}
      </div>
      <a href="/" class="menu-item">SimplexRentalis</a>
    </div>
  </div>

  <!-- Contenido principal -->
  <div id="main-content">
    {% block content %}
    {% endblock %}
  </div>

  <!-- Modal de inicio de sesión o registro -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Iniciar sesión</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalContent">
          <!-- Formulario de inicio de sesión -->
          <form id="loginForm" method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label for="username" class="form-label">Nombre de usuario</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Iniciar sesión</button>
          </form>
          <p class="mt-3">¿No tienes cuenta? <a href="#" id="showRegisterForm">Registrate aquí</a></p>

          <!-- Formulario de registro (inicialmente oculto) -->
          <form id="registerForm" method="post" style="display:none;">
            {% csrf_token %}
            <div class="mb-3">
              <label for="register_username" class="form-label">Nombre de usuario</label>
              <input type="text" class="form-control" id="register_username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="register_email" class="form-label">Correo</label>
              <input type="email" class="form-control" id="register_email" name="email" required>
            </div>
            <div class="mb-3">
              <label for="register_phone" class="form-label">Teléfono</label>
              <input type="text" class="form-control" id="register_phone" name="phone" required>
            </div>
            <div class="mb-3">
              <label for="register_password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="register_password" name="password" required>
            </div>
            <div class="mb-3">
              <label for="register_confirm_password" class="form-label">Repetir Contraseña</label>
              <input type="password" class="form-control" id="register_confirm_password" name="confirm_password" required>
            </div>
            <div class="mb-3">
              <label for="register_gender" class="form-label">Género</label>
              <select class="form-control" id="register_gender" name="gender">
                <option value="male">Masculino</option>
                <option value="female">Femenino</option>
                <option value="other">Otro</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="register_birthday" class="form-label">Fecha de nacimiento</label>
              <input type="date" class="form-control" id="register_birthday" name="birthday">
            </div>
            <div class="mb-3">
              <label for="register_avatar" class="form-label">Avatar (Opcional)</label>
              <input type="file" class="form-control" id="register_avatar" name="avatar">
            </div>
            <button type="submit" class="btn btn-primary w-100">Registrar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Aquí va el código JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();  // Evita que el formulario se envíe de forma tradicional

      const formData = new FormData(this);  // Obtén los datos del formulario
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;  // Obtén el token CSRF

      fetch("{% url 'login' %}", {  // Realiza la solicitud a la vista de login
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',  // Asegura que se hace una solicitud AJAX
          'X-CSRFToken': csrfToken  // Enviamos el token CSRF
        }
      })
      .then(response => response.json())  // Espera la respuesta en formato JSON
      .then(data => {
        if (data.success) {
          // Si el inicio de sesión es exitoso, actualiza la interfaz
          const userMenu = document.getElementById('userMenu');
          const loginButton = document.querySelector('.btn-login');
          
          // Oculta el botón de login
          loginButton.style.display = 'none';
          
          // Muestra el dropdown con el avatar y nombre del usuario
          userMenu.innerHTML = `
            <a href="#" class="d-flex align-items-center" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="${data.avatar_url}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
              <span class="text-light">${data.username}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'account_settings' %}">Configuración de la cuenta</a></li>
            </ul>
          `;
          
          // Cierra el modal de inicio de sesión
          const modal = new bootstrap.Modal(document.getElementById('loginModal'));
          modal.hide();
          
          // Recargar la página para actualizar los tokens CSRF después de iniciar sesión
          location.reload();
        } else {
          alert(data.message || "Error en el inicio de sesión.");
        }
      })
      .catch(error => {
        alert("Hubo un problema con la solicitud.");
      });
    });

    // Mostrar el formulario de registro
    document.getElementById('showRegisterForm').addEventListener('click', function() {
      // Ocultar el texto de "¿No tienes cuenta? Registrate aquí"
      document.querySelector('#modalContent p').style.display = 'none';
      
      // Mostrar el formulario de registro
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('loginModalLabel').innerText = "Registrar cuenta";
    });
  </script>

</body>
</html>
