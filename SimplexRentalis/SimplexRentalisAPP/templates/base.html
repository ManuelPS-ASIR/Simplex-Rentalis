<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% load static %}
  <title>{% block title %}Página{% endblock %}</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Enlace al archivo CSS dentro de la carpeta static -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

  <!-- Menú de la hamburguesa en el lateral -->
  <div id="menu">
    <span class="hamburguesa">&#9776;</span> <!-- Ícono de hamburguesa -->
    <a href="#" class="menu-item">Mis reservas</a>
    <a href="mis_propiedades/" class="menu-item">Mis propiedades</a>
    <a href="#" class="menu-item">Inicio</a>
    <a href="#" class="menu-item">Servicios</a>
    <a href="#" class="menu-item">Acerca de</a>
    <a href="#" class="menu-item">Contacto</a>
  </div>

  <!-- Barra superior fija -->
  <div class="navbar">
    <div class="container-fluid">
      <!-- Verificamos si el usuario está autenticado -->
      <div id="userMenu" class="position-relative">
        {% if user.is_authenticated %}
        <!-- Si está autenticado, mostramos su nombre y avatar con un dropdown -->
        <a href="#" class="d-flex align-items-center" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
          <span class="text-light">{{ user.username }}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
          <li><a class="dropdown-item" href="{% url 'account_settings' %}">Configuración de la cuenta</a></li>
          <li><a class="dropdown-item" href="{% url 'logout' %}">Cerrar sesión</a></li>  <!-- Botón de cerrar sesión -->
        </ul>
        {% else %}
        <!-- Si no está autenticado, mostramos el botón de Iniciar sesión -->
        <button class="btn btn-outline-light btn-login" data-bs-toggle="modal" data-bs-target="#loginModal">Iniciar Sesión</button>
        {% endif %}
      </div>
      <a href="/" class="menu-item">SimplexRentalis</a>
    </div>
  </div>

  <!-- Contenido principal -->
  <div id="main-content">
    {% block content %}
    {% endblock %}
  </div>

  <!-- Modal de inicio de sesión o registro -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Iniciar sesión</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalContent">
          <!-- Formulario de inicio de sesión -->
          <form id="loginForm" method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label for="username" class="form-label">Nombre de usuario</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Iniciar sesión</button>
          </form>
          <p class="mt-3" id="registerPrompt">¿No tienes cuenta? <a href="#" id="showRegisterForm">Regístrate aquí</a></p>

          <!-- Formulario de registro (inicialmente oculto) -->
          <form id="registerForm" method="post" style="display:none;">
            {% csrf_token %}
            <div class="mb-3">
              <label for="register_username" class="form-label">Nombre de usuario</label>
              <input type="text" class="form-control" id="register_username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="register_email" class="form-label">Correo</label>
              <input type="email" class="form-control" id="register_email" name="email" required>
            </div>
            <div class="mb-3">
              <label for="register_phone" class="form-label">Teléfono</label>
              <input type="text" class="form-control" id="register_phone" name="telefono" required>
            </div>
            <div class="mb-3">
              <label for="register_password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="register_password" name="password1" required>
            </div>
            <div class="mb-3">
              <label for="register_confirm_password" class="form-label">Repetir Contraseña</label>
              <input type="password" class="form-control" id="register_confirm_password" name="password2" required>
            </div>
            <div class="mb-3">
              <label for="register_gender" class="form-label">Género</label>
              <select class="form-control" id="register_gender" name="genero" required>
                  <option value="masculino">Masculino</option>
                  <option value="femenino">Femenino</option>
                  <option value="otro">Otro</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="register_birthday" class="form-label">Fecha de nacimiento</label>
              <input type="date" class="form-control" id="register_birthday" name="fecha_nacimiento" required>
            </div>
            <div class="mb-3">
              <label for="register_avatar" class="form-label">Imagen de Perfil (Opcional)</label>
              <input type="file" class="form-control" id="register_avatar" name="avatar">
            </div>
            <button type="submit" class="btn btn-primary w-100">Registrar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Aquí va el código JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Manejador para el envío del formulario de inicio de sesión
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();  // Evita que el formulario se envíe de forma tradicional

      const formData = new FormData(this);  // Obtén los datos del formulario
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;  // Obtén el token CSRF

      fetch("{% url 'login' %}", {  // Realiza la solicitud a la vista de login
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',  // Asegura que se hace una solicitud AJAX
          'X-CSRFToken': csrfToken  // Enviamos el token CSRF
        }
      })
      .then(response => response.json())  // Espera la respuesta en formato JSON
      .then(data => {
        if (data.success) {
          // Si el inicio de sesión es exitoso, actualiza la interfaz
          const userMenu = document.getElementById('userMenu');
          const loginButton = document.querySelector('.btn-login');
          
          // Oculta el botón de login
          loginButton.style.display = 'none';
          
          // Muestra el dropdown con el avatar y nombre del usuario
          userMenu.innerHTML = `
            <a href="#" class="d-flex align-items-center" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="${data.avatar}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
              <span class="text-light">${data.username}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'account_settings' %}">Configuración de la cuenta</a></li>
              <li><a class="dropdown-item" href="{% url 'logout' %}">Cerrar sesión</a></li>
            </ul>
          `;
          
          // Cierra el modal
          const loginModalElement = document.getElementById('loginModal');
          const loginModal = bootstrap.Modal.getInstance(loginModalElement);
          loginModal.hide();
          
        } else {
          // Si ocurre un error en el login, muestra el error
          alert(data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Hubo un error al intentar iniciar sesión.');
      });
    });

    // Mostrar el formulario de registro
    document.getElementById("showRegisterForm").addEventListener("click", function(e) {
      e.preventDefault();  // Evita la acción de enlace
      document.getElementById("loginForm").style.display = "none";  // Ocultar el formulario de login
      document.getElementById("registerForm").style.display = "block";  // Mostrar el formulario de registro
      document.getElementById("registerPrompt").style.display = "none";  // Ocultar el mensaje
    });

    // Manejador para el envío del formulario de registro con AJAX
    document.getElementById("registerForm").addEventListener("submit", function(e) {
      e.preventDefault();  // Evita que el formulario se envíe de forma tradicional

      const formData = new FormData(this);  // Obtén los datos del formulario
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;  // Obtén el token CSRF

      fetch("{% url 'register' %}", {  // Realiza la solicitud a la vista de registro
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',  // Asegura que se hace una solicitud AJAX
          'X-CSRFToken': csrfToken  // Enviamos el token CSRF
        }
      })
      .then(response => response.json())  // Espera la respuesta en formato JSON
      .then(data => {
        if (data.success) {
          // Si el registro es exitoso, muestra un mensaje de éxito o redirige
          //alert('Registro exitoso. Iniciando sesión automáticamente...');
          
          // Actualizar el menú de usuario en la interfaz sin recargar la página
          const userMenu = document.getElementById('userMenu');
          
          // Ocultar el formulario de registro
          document.getElementById("registerForm").style.display = "none";
          
          // Mostrar el nuevo menú de usuario con avatar y nombre
          userMenu.innerHTML = `
            <a href="#" class="d-flex align-items-center" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="${data.avatar_url}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
              <span class="text-light">${data.username}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'account_settings' %}">Configuración de la cuenta</a></li>
              <li><a class="dropdown-item" href="{% url 'logout' %}">Cerrar sesión</a></li>
            </ul>
          `;

          // Cierra el modal de login/regsitro
          const loginModalElement = document.getElementById('loginModal');
          let loginModal = bootstrap.Modal.getInstance(loginModalElement);
          if (!loginModal) {
            loginModal = new bootstrap.Modal(loginModalElement);
          }
          loginModal.hide();  // Cierra el modal

        } else {
          // Si ocurre un error, muestra el mensaje de error
          alert(data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Hubo un error al intentar registrarse.');
      });
    });


    // Al cerrar el modal, volver al formulario de inicio de sesión
    const loginModalElement = document.getElementById('loginModal');
    loginModalElement.addEventListener('hidden.bs.modal', function() {
      document.getElementById("loginForm").style.display = "block";  // Asegura que el formulario de login se muestre
      document.getElementById("registerForm").style.display = "none";  // Oculta el formulario de registro
      document.getElementById("registerPrompt").style.display = "block";  // Muestra el mensaje de registro
    });
  </script>

</body>
</html>
